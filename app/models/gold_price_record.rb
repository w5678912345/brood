# encoding: utf-8
class GoldPriceRecord < ActiveRecord::Base
  attr_accessible :average_price, :max_price, :server_id,:max_count
  belongs_to :server

  scope :time_scope,lambda{|start_time,end_time|where("gold_price_records.created_at in (?)",start_time..end_time)}


  DTA_SERVER = JSON.parse("{\"安徽1区\":[\"100\",\"1058\",\"00\",\"安徽1区\",\"AH1Q\"],\"安徽2区\":[\"100\",\"1059\",\"00\",\"安徽2区\",\"AH2Q\"],\"安徽3区\":[\"100\",\"1060\",\"00\",\"安徽3区\",\"AH3Q\"],\"重庆1区\":[\"100\",\"1068\",\"00\",\"重庆1区\",\"CQ1Q\"],\"重庆2区\":[\"100\",\"1069\",\"00\",\"重庆2区\",\"CQ2Q\"],\"福建1区\":[\"100\",\"1029\",\"00\",\"福建1区\",\"FJ1Q\"],\"福建2区\":[\"100\",\"1030\",\"00\",\"福建2区\",\"FJ2Q\"],\"福建3/4区\":[\"100\",\"1031\",\"00\",\"福建3/4区\",\"FJ3/4Q\"],\"广东1区\":[\"100\",\"1018\",\"00\",\"广东1区\",\"GD1Q\"],\"广东2区\":[\"100\",\"1019\",\"00\",\"广东2区\",\"GD2Q\"],\"广东3区\":[\"100\",\"1020\",\"00\",\"广东3区\",\"GD3Q\"],\"广东4区\":[\"100\",\"1021\",\"00\",\"广东4区\",\"GD4Q\"],\"广东5区\":[\"100\",\"1022\",\"00\",\"广东5区\",\"GD5Q\"],\"广东6区\":[\"100\",\"1023\",\"00\",\"广东6区\",\"GD6Q\"],\"广东7区\":[\"100\",\"1024\",\"00\",\"广东7区\",\"GD7Q\"],\"广东8区\":[\"100\",\"1025\",\"00\",\"广东8区\",\"GD8Q\"],\"广东9区\":[\"100\",\"1026\",\"00\",\"广东9区\",\"GD9Q\"],\"广东10区\":[\"100\",\"1027\",\"00\",\"广东10区\",\"GD10Q\"],\"广东11区\":[\"100\",\"1028\",\"00\",\"广东11区\",\"GD11Q\"],\"广东12区\":[\"100\",\"1083\",\"00\",\"广东12区\",\"GD12Q\"],\"广东13区\":[\"100\",\"1087\",\"00\",\"广东13区\",\"GD13Q\"],\"广西1区\":[\"100\",\"1055\",\"00\",\"广西1区\",\"GX1Q\"],\"广西2/4区\":[\"100\",\"1056\",\"00\",\"广西2/4区\",\"GX2/4Q\"],\"广西3区\":[\"100\",\"1057\",\"00\",\"广西3区\",\"GX3Q\"],\"广西5区\":[\"100\",\"1086\",\"00\",\"广西5区\",\"GX5Q\"],\"广州1/2区\":[\"100\",\"1066\",\"00\",\"广州1/2区\",\"GZ1/2Q\"],\"贵州1区\":[\"100\",\"1080\",\"00\",\"贵州1区\",\"GZ1Q\"],\"湖北1区\":[\"100\",\"1012\",\"00\",\"湖北1区\",\"HB1Q\"],\"湖北2区\":[\"100\",\"1013\",\"00\",\"湖北2区\",\"HB2Q\"],\"湖北3区\":[\"100\",\"1014\",\"00\",\"湖北3区\",\"HB3Q\"],\"湖北4区\":[\"100\",\"1015\",\"00\",\"湖北4区\",\"HB4Q\"],\"湖北5区\":[\"100\",\"1016\",\"00\",\"湖北5区\",\"HB5Q\"],\"湖北6区\":[\"100\",\"1017\",\"00\",\"湖北6区\",\"HB6Q\"],\"湖北7区\":[\"100\",\"1077\",\"00\",\"湖北7区\",\"HB7Q\"],\"湖北8区\":[\"100\",\"1084\",\"00\",\"湖北8区\",\"HB8Q\"],\"湖南1区\":[\"100\",\"1041\",\"00\",\"湖南1区\",\"HN1Q\"],\"湖南2区\":[\"100\",\"1042\",\"00\",\"湖南2区\",\"HN2Q\"],\"湖南3区\":[\"100\",\"1043\",\"00\",\"湖南3区\",\"HN3Q\"],\"湖南4区\":[\"100\",\"1044\",\"00\",\"湖南4区\",\"HN4Q\"],\"湖南5区\":[\"100\",\"1045\",\"00\",\"湖南5区\",\"HN5Q\"],\"湖南6区\":[\"100\",\"1046\",\"00\",\"湖南6区\",\"HN6Q\"],\"湖南7区\":[\"100\",\"1076\",\"00\",\"湖南7区\",\"HN7Q\"],\"江苏1区\":[\"100\",\"1047\",\"00\",\"江苏1区\",\"JS1Q\"],\"江苏2区\":[\"100\",\"1048\",\"00\",\"江苏2区\",\"JS2Q\"],\"江苏3区\":[\"100\",\"1049\",\"00\",\"江苏3区\",\"JS3Q\"],\"江苏4区\":[\"100\",\"1050\",\"00\",\"江苏4区\",\"JS4Q\"],\"江苏5/7区\":[\"100\",\"1051\",\"00\",\"江苏5/7区\",\"JS5/7Q\"],\"江苏6区\":[\"100\",\"1052\",\"00\",\"江苏6区\",\"JS6Q\"],\"江苏8区\":[\"100\",\"1054\",\"00\",\"江苏8区\",\"JS8Q\"],\"江西1区\":[\"100\",\"1061\",\"00\",\"江西1区\",\"JX1Q\"],\"江西2区\":[\"100\",\"1062\",\"00\",\"江西2区\",\"JX2Q\"],\"江西3区\":[\"100\",\"1063\",\"00\",\"江西3区\",\"JX3Q\"],\"四川2区\":[\"100\",\"1006\",\"00\",\"四川2区\",\"SC2Q\"],\"四川1区\":[\"100\",\"1007\",\"00\",\"四川1区\",\"SC1Q\"],\"四川3区\":[\"100\",\"1008\",\"00\",\"四川3区\",\"SC3Q\"],\"四川4区\":[\"100\",\"1009\",\"00\",\"四川4区\",\"SC4Q\"],\"四川5区\":[\"100\",\"1010\",\"00\",\"四川5区\",\"SC5Q\"],\"四川6区\":[\"100\",\"1011\",\"00\",\"四川6区\",\"SC6Q\"],\"上海1区\":[\"100\",\"1037\",\"00\",\"上海1区\",\"SH1Q\"],\"上海2区\":[\"100\",\"1038\",\"00\",\"上海2区\",\"SH2Q\"],\"上海3区\":[\"100\",\"1039\",\"00\",\"上海3区\",\"SH3Q\"],\"上海4/5区\":[\"100\",\"1040\",\"00\",\"上海4/5区\",\"SH4/5Q\"],\"陕西1区\":[\"100\",\"1064\",\"00\",\"陕西1区\",\"SX1Q\"],\"陕西2/3区\":[\"100\",\"1065\",\"00\",\"陕西2/3区\",\"SX2/3Q\"],\"西北1区\":[\"100\",\"1000\",\"00\",\"西北1区\",\"XB1Q\"],\"西北2/3区\":[\"100\",\"1002\",\"00\",\"西北2/3区\",\"XB2/3Q\"],\"新疆1区\":[\"100\",\"1081\",\"00\",\"新疆1区\",\"XJ1Q\"],\"西南1区\":[\"100\",\"1003\",\"00\",\"西南1区\",\"XN1Q\"],\"西南2区\":[\"100\",\"1004\",\"00\",\"西南2区\",\"XN2Q\"],\"西南3区\":[\"100\",\"1005\",\"00\",\"西南3区\",\"XN3Q\"],\"云贵1区\":[\"100\",\"1082\",\"00\",\"云贵1区\",\"YG1Q\"],\"云南1区\":[\"100\",\"1079\",\"00\",\"云南1区\",\"YN1Q\"],\"浙江1区\":[\"100\",\"1032\",\"00\",\"浙江1区\",\"ZJ1Q\"],\"浙江2区\":[\"100\",\"1033\",\"00\",\"浙江2区\",\"ZJ2Q\"],\"浙江3区\":[\"100\",\"1034\",\"00\",\"浙江3区\",\"ZJ3Q\"],\"浙江4/5区\":[\"100\",\"1035\",\"00\",\"浙江4/5区\",\"ZJ4/5Q\"],\"浙江6区\":[\"100\",\"1075\",\"00\",\"浙江6区\",\"ZJ6Q\"],\"浙江7区\":[\"100\",\"1085\",\"00\",\"浙江7区\",\"ZJ7Q\"],\"北京1区\":[\"101\",\"1010\",\"00\",\"北京1区\",\"BJ1Q\"],\"北京2/4区\":[\"101\",\"1011\",\"00\",\"北京2/4区\",\"BJ2/4Q\"],\"北京3区\":[\"101\",\"1012\",\"00\",\"北京3区\",\"BJ3Q\"],\"东北1区\":[\"101\",\"1004\",\"00\",\"东北1区\",\"DB1Q\"],\"东北2区\":[\"101\",\"1005\",\"00\",\"东北2区\",\"DB2Q\"],\"东北3/7区\":[\"101\",\"1006\",\"00\",\"东北3/7区\",\"DB3/7Q\"],\"东北4/5/6区\":[\"101\",\"1007\",\"00\",\"东北4/5/6区\",\"DB4/5/6Q\"],\"华北1区\":[\"101\",\"1000\",\"00\",\"华北1区\",\"HB1Q\"],\"华北2区\":[\"101\",\"1001\",\"00\",\"华北2区\",\"HB2Q\"],\"华北3区\":[\"101\",\"1002\",\"00\",\"华北3区\",\"HB3Q\"],\"华北4区\":[\"101\",\"1003\",\"00\",\"华北4区\",\"HB4Q\"],\"河北1区\":[\"101\",\"1030\",\"00\",\"河北1区\",\"HB1Q\"],\"河北2/3区\":[\"101\",\"1031\",\"00\",\"河北2/3区\",\"HB2/3Q\"],\"河北4区\":[\"101\",\"1038\",\"00\",\"河北4区\",\"HB4Q\"],\"河北5区\":[\"101\",\"1043\",\"00\",\"河北5区\",\"HB5Q\"],\"黑龙江1区\":[\"101\",\"1033\",\"00\",\"黑龙江1区\",\"HLJ1Q\"],\"黑龙江2/3区\":[\"101\",\"1034\",\"00\",\"黑龙江2/3区\",\"HLJ2/3Q\"],\"河南1区\":[\"101\",\"1019\",\"00\",\"河南1区\",\"HN1Q\"],\"河南2区\":[\"101\",\"1020\",\"00\",\"河南2区\",\"HN2Q\"],\"河南3区\":[\"101\",\"1021\",\"00\",\"河南3区\",\"HN3Q\"],\"河南4区\":[\"101\",\"1022\",\"00\",\"河南4区\",\"HN4Q\"],\"河南5区\":[\"101\",\"1023\",\"00\",\"河南5区\",\"HN5Q\"],\"河南6区\":[\"101\",\"1024\",\"00\",\"河南6区\",\"HN6Q\"],\"河南7区\":[\"101\",\"1045\",\"00\",\"河南7区\",\"HN7Q\"],\"吉林1/2区\":[\"101\",\"1036\",\"00\",\"吉林1/2区\",\"JL1/2Q\"],\"辽宁1区\":[\"101\",\"1025\",\"00\",\"辽宁1区\",\"LN1Q\"],\"辽宁2区\":[\"101\",\"1026\",\"00\",\"辽宁2区\",\"LN2Q\"],\"辽宁3区\":[\"101\",\"1027\",\"00\",\"辽宁3区\",\"LN3Q\"],\"内蒙古1区\":[\"101\",\"1040\",\"00\",\"内蒙古1区\",\"NMG1Q\"],\"山东1区\":[\"101\",\"1013\",\"00\",\"山东1区\",\"SD1Q\"],\"山东2/7区\":[\"101\",\"1014\",\"00\",\"山东2/7区\",\"SD2/7Q\"],\"山东3区\":[\"101\",\"1015\",\"00\",\"山东3区\",\"SD3Q\"],\"山东4区\":[\"101\",\"1016\",\"00\",\"山东4区\",\"SD4Q\"],\"山东5区\":[\"101\",\"1017\",\"00\",\"山东5区\",\"SD5Q\"],\"山东6区\":[\"101\",\"1018\",\"00\",\"山东6区\",\"SD6Q\"],\"山西1区\":[\"101\",\"1028\",\"00\",\"山西1区\",\"SX1Q\"],\"山西2区\":[\"101\",\"1029\",\"00\",\"山西2区\",\"SX2Q\"],\"天津1区\":[\"101\",\"1039\",\"00\",\"天津1区\",\"TJ1Q\"],\"超级锦标赛\":[\"102\",\"1000\",\"00\",\"超级锦标赛\",\"CJJBS\"],\"跨区PK服\":[\"102\",\"1001\",\"00\",\"跨区PK服\",\"KQPKF\"],\"体验服\":[\"103\",\"1000\",\"00\",\"体验服\",\"TYF\"],\"测试服\":[\"104\",\"1000\",\"00\",\"测试服\",\"CSF\"]}")
  
  #response = HTTParty.get('http://www.17uoo.com/Aspx/Ui/SellGold/Index.aspx?Command=Search&Time=1432517574026&Order=dmPrice%20desc,Speed%20asc,nSucceedOrder%20desc&GameNo=227&ZoneNo=101&ServerNo=&Mode=2&CampNo=&Where=vcServerName&Keyword=&PageIndex=1&PageSize=10')
  #j['Tables'][1]['Rows']
  def self.create_all_from_net
    Server.all.each do |s|
      self.create_by_server s
    end
  end
  def self.create_by_server server
    server_data = DTA_SERVER[server.name]
    #server_data = ["100", "1058", "00", "安徽1区", "AH1Q"]
    return if server_data.nil?
    response = HTTParty.get("http://www.17uoo.com/Aspx/Ui/SellGold/Index.aspx?Command=Search&Time=1432517574026&Order=dmPrice%20desc,Speed%20asc,nSucceedOrder%20desc&GameNo=227&ZoneNo=#{server_data[0]}&ServerNo=#{server_data[1]}&Mode=2&CampNo=&Where=vcServerName&Keyword=&PageIndex=1&PageSize=10")   
    j = JSON.parse response.body
    gold_price = j['Tables'][1]['Rows'].map{|e| e[4].to_f*10000 if e[3] == "万金币"}
    gold_max_count = j['Tables'][1]['Rows'].map{|e| e[5].to_i if e[3] == "万金币"}
    GoldPriceRecord.create :server_id => server.id,
        :max_price => gold_price.max,
        :average_price => gold_price.inject{|s,e|s+e} / gold_price.size
        :max_count => gold_max_count.inject(0){|sum,x| sum + x }
  end
end